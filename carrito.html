<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carrito de Entradas</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; display: flex; justify-content: space-between; }
    table { border-collapse: collapse; width: 60%; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background-color: #f4f4f4; }
    input[type="number"] { width: 60px; }
    .totals { margin-top: 20px; font-size: 1.1em; }
    .form-container { width: 35%; padding-left: 20px; border-left: 2px solid #eee; }
    .form-container label { display: block; margin-top: 10px; }
    .form-container input, .form-container select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
    .buttons { margin-top: 20px; }
    button { padding: 10px 20px; font-size: 1em; cursor: pointer; }
    .totals span { display: inline-block; width: 150px; }
  </style>
</head>
<body>

<div>
  <table>
    <thead>
      <tr>
        <th>Tipo de Entrada</th>
        <th>Precio</th>
        <th>Cantidad</th>
      </tr>
    </thead>
    <tbody id="ticket-table"></tbody>
  </table>

  <div class="totals">
    <p><span>Total de Entradas:</span><strong id="total-cant">0</strong></p>
    <p><span>Total a Cobrar:</span><strong id="total-precio">$0.00</strong></p>
  </div>

  <div class="buttons">
    <button onclick="resetForm()">Limpiar</button>
    <button onclick="comprar()">Comprar</button>
  </div>
</div>

<div class="form-container">
  <h3>Datos del Comprador</h3>
  <form id="buyer-form">
    <!-- Campos se generarán dinámicamente -->
  </form>
</div>

<script>
  let entradas = [];
  let formulario = [];

  // Cargar datos desde JSON externo
  fetch('api_datos.json')
    .then(response => response.json())
    .then(data => {
      entradas = data.localidades;
      formulario = data.formulario;
      mostrarEntradas();
      generarFormulario();
    })
    .catch(error => {
      console.error('Error cargando datos de la API:', error);
      alert('Error cargando datos de la API. Asegúrate de abrir desde un servidor o Live Server.');
    });

  const tabla = document.getElementById('ticket-table');
  const formContainer = document.getElementById('buyer-form');

  function mostrarEntradas() {
    tabla.innerHTML = '';
    entradas.forEach((entrada, index) => {
      const fila = document.createElement('tr');

      const tdNombre = document.createElement('td');
      tdNombre.textContent = entrada.nombre;

      const tdPrecio = document.createElement('td');
      tdPrecio.textContent = `$${entrada.precio.toFixed(2)}`;

      const tdCantidad = document.createElement('td');
      const inputCantidad = document.createElement('input');
      inputCantidad.type = 'number';
      inputCantidad.min = 0;
      inputCantidad.max = entrada.disponibilidad === "Disponible" ? 1000 : 0;
      inputCantidad.value = 0;
      inputCantidad.dataset.precio = entrada.precio;
      inputCantidad.dataset.index = index;
      inputCantidad.addEventListener('input', calcularTotales);

      tdCantidad.appendChild(inputCantidad);
      fila.appendChild(tdNombre);
      fila.appendChild(tdPrecio);
      fila.appendChild(tdCantidad);
      tabla.appendChild(fila);
    });
  }

  function calcularTotales() {
    let totalCantidad = 0;
    let totalPrecio = 0;
    document.querySelectorAll('#ticket-table input[type="number"]').forEach(input => {
      const cantidad = parseInt(input.value) || 0;
      const precio = parseFloat(input.dataset.precio);
      totalCantidad += cantidad;
      totalPrecio += cantidad * precio;
    });
    document.getElementById('total-cant').textContent = totalCantidad;
    document.getElementById('total-precio').textContent = `$${totalPrecio.toFixed(2)}`;
  }

  function resetForm() {
    document.querySelectorAll('#ticket-table input[type="number"]').forEach(input => input.value = 0);
    calcularTotales();
    formContainer.reset();
  }

  function generarFormulario() {
    formContainer.innerHTML = '';
    formulario.forEach(campo => {
      const label = document.createElement('label');
      label.textContent = campo.campo + ':';
      let input;

      if(campo.campo === 'documento') {
        // Tipo de documento
        const select = document.createElement('select');
        select.name = 'tipo_documento';
        campo.opciones.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          select.appendChild(option);
        });
        if(campo.requerido) select.required = true;
        formContainer.appendChild(label);
        formContainer.appendChild(select);

        // Número de documento
        const labelNum = document.createElement('label');
        labelNum.textContent = 'Número de Documento:';
        const inputNum = document.createElement('input');
        inputNum.name = 'num_documento';
        inputNum.type = 'text'; // permitimos alfanumérico
        if(campo.requerido) inputNum.required = true;
        formContainer.appendChild(labelNum);
        formContainer.appendChild(inputNum);

      } else if(campo.tipo === 'select') {
        input = document.createElement('select');
        input.name = campo.campo;
        campo.opciones.forEach(opt => {
          const option = document.createElement('option');
          option.value = opt;
          option.textContent = opt;
          input.appendChild(option);
        });
        if(campo.requerido) input.required = true;
        formContainer.appendChild(label);
        formContainer.appendChild(input);

      } else {
        input = document.createElement('input');
        input.type = campo.tipo === 'texto' ? 'text' : campo.tipo;
        input.name = campo.campo;
        if(campo.requerido) input.required = true;
        formContainer.appendChild(label);
        formContainer.appendChild(input);
      }
    });

    // Checkbox de aceptación de términos
    const termLabel = document.createElement('label');
    const termInput = document.createElement('input');
    termInput.type = 'checkbox';
    termInput.id = 'aceptar';
    termInput.required = true;
    termLabel.appendChild(termInput);
    termLabel.appendChild(document.createTextNode(' Acepto los términos y condiciones'));
    formContainer.appendChild(termLabel);
  }

  function comprar() {
    const form = document.getElementById('buyer-form');

    // Validar campos requeridos según JSON
    let faltan = [];
    formulario.forEach(campo => {
      if(campo.campo === 'documento') return; // se valida más abajo
      const input = form.querySelector(`[name="${campo.campo}"]`);
      if(campo.requerido && (!input.value || (input.type === 'number' && isNaN(input.value)))) {
        faltan.push(campo.campo);
      }
    });

    // Validar documento
    const tipoDoc = form.querySelector('[name="tipo_documento"]');
    const numDoc = form.querySelector('[name="num_documento"]');
    if(!tipoDoc.value) faltan.push('Tipo de Documento');
    if(!numDoc.value) faltan.push('Número de Documento');
    if(tipoDoc.value !== 'Pasaporte' && numDoc.value && !/^\d+$/.test(numDoc.value)) {
      alert('Número de Documento debe ser solo numérico para Cédula o RUC.');
      return;
    }

    if(faltan.length > 0) {
      alert('Faltan campos requeridos: ' + faltan.join(', '));
      return; // Bloquea la compra
    }

    // Validar aceptación de términos
    if (!document.getElementById('aceptar').checked) {
      alert('Debes aceptar los términos y condiciones.');
      return;
    }

    // Crear objeto comprador con todos los datos
    const comprador = {};
    formulario.forEach(campo => {
      if(campo.campo === 'documento') {
        comprador['tipo_documento'] = tipoDoc.value;
        comprador['num_documento'] = numDoc.value;
      } else {
        const input = form.querySelector(`[name="${campo.campo}"]`);
        comprador[campo.campo] = input.value;
      }
    });

    // Generar ordenes
    let ordenes = [];
    let ordenConsecutiva = 1;
    document.querySelectorAll('#ticket-table input[type="number"]').forEach(input => {
      const cantidad = parseInt(input.value) || 0;
      if (cantidad > 0) {
        const entrada = entradas[input.dataset.index];
        ordenes.push({
          orden: ordenConsecutiva,
          nombre_ticket: entrada.nombre,
          cantidad: cantidad,
          importe_total: +(cantidad * entrada.precio).toFixed(2),
          comprador: comprador
        });
        ordenConsecutiva++;
      }
    });

    if (ordenes.length === 0) {
      alert('No has seleccionado ninguna entrada.');
      return;
    }

    // Descargar JSON de salida
    const blob = new Blob([JSON.stringify(ordenes, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'API_de_salida.json';
    link.click();

    alert('Compra realizada con éxito. El resumen se ha guardado como API_de_salida.json.');
  }
</script>

</body>
</html>
